#!/bin/sh -efu

. shell-error
. shell-quote
. shell-git-config

. "@PREFIX@/vm-sh-config"

git_config_location_exists "$vm_config_file" "vm.$vm_profile" ||
	fatal "Profile not exists: vm.$vm_profile"

vm_read_config "$vm_config_file"

rootfs=
git_config_get rootfs "$vm_config_file" "vm.$vm_profile.rootfs"

[ -d "$rootfs" ] ||
	fatal "Rootfs not found"

[ "$#" -gt 0 ] ||
	set -- /bin/bash

{
	printf '#!/bin/sh\n'
	printf 'exec'
	printf ' "%s"' "$@"
	printf '\n'
} > "$rootfs/virt/sandbox.sh"
chmod +x -- "$rootfs/virt/sandbox.sh"

exec "@PREFIX@/vm-command-run"
