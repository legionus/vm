#!/bin/sh -efu

if [ -n "${VM_USAGE-}" ]; then
	printf 'setup <profile> [options]\n'
	exit 0
fi

if [ -n "${VM_HELP-}" ]; then
	printf 'Setup a new sandbox\n'
	exit 0
fi

if [ -n "${VM_HELP_OPTIONS-}" ]; then
	cat <<-EOF
	  -g, --global=DIR        creates global rootfs;
	  -r, --kconfig-requires  show kernel options required for the specified profile;
	  -m, --kconfig-merge     merge required kernel config fragments into .config;
	EOF
	exit 0
fi

. shell-error
. shell-git-config

GETOPT_ALLOW_UNKNOWN=
TEMP=`getopt -n $PROG -o 'g:,m,r' -l 'global:,kconfig-merge,kconfig-requires' -- "$@"` ||
	show_usage
eval set -- "$TEMP"

global=
show_kconfig_requires=
merge_kconfig_requires=

while :; do
	case "$1" in
		-g|--global) shift
			global="$1"
			;;
		-m|--kconfig-merge)
			merge_kconfig_requires=1
			;;
		-r|--kconfig-requires)
			show_kconfig_requires=1
			;;
		--) shift; break
			;;
	esac
	shift
done

[ -n "$vm_profile" ] ||
	fatal "Profile name be specified"

if [ -z "$global" ]; then
	. "@PREFIX@/vm-sh-config"

	vm_read_common_config

	vm_profiles=
	git_config_get vm_profiles "$vm_config_file" "vm.profiles"

	dest_dir="$vm_profiles/$vm_profile/rootfs"
else
	verbose "Setup global rootfs."
	dest_dir="$global"
fi

if [ -n "$show_kconfig_requires" ]; then
	cd '@PREFIX@'
	grep -h -v -e '^[[:space:]]*\(#.*\)\?$' $kernel_config_expect |
		sort -u
	exit
fi

if [ -n "$merge_kconfig_requires" ]; then
	if [ -z "$kernel_dir" ]; then
		n="${qemu_kernel-}"
		while [ -e "$n" ]; do
			if [ -s "${n%/*}/.config" ]; then
				kernel_dir="${n%/*}"
				break
			fi
			[ -z "${n##*/*}" ] ||
				break
			n="${n%/*}"
		done
	fi

	[ -d "$kernel_dir" ] ||
		fatal "kernel config merge doesn't make sense without kernel sources."

	[ -s "$kernel_dir/.config" ] ||
		fatal "$kernel_dir/.config: kernel config not found."

	merge_config="$kernel_dir/scripts/kconfig/merge_config.sh"
	[ -x "$merge_config" ] ||
		fatal "$merge_config: not found or not executable. Can't merge."

	cd '@PREFIX@'
	"$merge_config" -m -y -O "$kernel_dir" "$kernel_dir/.config" $kernel_config_expect
	exit
fi

vm_check_kernel_config

git_config_location_exists "$vm_config_file" "vm.$vm_profile" ||
	verbose "Profile does not exist. Creating ..."

git_config_set "$vm_config_file" "vm.$vm_profile.rootfs" "$dest_dir"
[ -z "${qemu_kernel-}" ] ||
	git_config_set "$vm_config_file" "vm.$vm_profile.kernel" "$qemu_kernel"
git_config_set "$vm_config_file" "vm.$vm_profile.append" "init=virt/init root=/dev/root rootflags=rw,trans=virtio,version=9p2000.L,setuid=0 rootfstype=9p rw"

git_config_unset  "$vm_config_file" "vm.$vm_profile.virtfs"
git_config_append "$vm_config_file" "vm.$vm_profile.virtfs" "$dest_dir:/dev/root"
git_config_append "$vm_config_file" "vm.$vm_profile.virtfs" "/:hostfs"

[ -d "$dest_dir" ] &&
	message "Updating rootfs: $dest_dir" ||
	message "Creating rootfs: $dest_dir"

mkdir ${verbose-} -p -- "$dest_dir"
cd "$dest_dir"

for n in dev etc home host proc root sys tmp var var/lib virt virt/home; do
	mkdir ${verbose-} -p -- "./$n"
done

for n in bin lib lib64 sbin usr etc/ld.so.conf; do
	[ -e "./$n" ] || [ -L "./$n" ] ||
		ln ${verbose-} -s -- "/host/$n" "./$n"
done

[ -f ./etc/passwd ] ||
	printf 'root:x:0:0:root:/root:/bin/sh\n' > ./etc/passwd
[ -f ./etc/group ] ||
	printf 'root:x:0:\n' > ./etc/group

cp ${verbose-} -- "@LIBEXECDIR@/init" ./virt/init
