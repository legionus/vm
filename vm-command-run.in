#!/bin/sh -efu

if [ -n "${VM_USAGE-}" ]; then
	printf 'run <profile>\n'
	exit 0
fi

if [ -n "${VM_HELP-}" ]; then
	printf 'Starts a virtual machine according to specified profile\n'
	exit 0
fi

if [ -n "${VM_HELP_OPTIONS-}" ]; then
	exit 0
fi

. shell-git-config

. "@PREFIX@/vm-sh-config"

debug_exec() {
	printf '%s \\\n' "$1"; shift
	opt=
	for a; do
		if [ -z "${a##-*}" ]; then
			[ -z "$opt" ] || printf '\\\n'
			printf '\t%s ' "$a"
			opt=1
		else
			printf '"%s" \\\n' "$a"
			opt=
		fi
	done
	printf '\t#\n'
}

vm_read_profile_config
vm_check_kernel_config

vm_profiles=
git_config_get vm_profiles "$vm_config_file" "vm.profiles"

dest_dir="$vm_profiles/$vm_profile"
mkdir $verbose -p -- "$dest_dir"

if [ -n "$qemu_logfile" ]; then
	buf="$workdir/qemu.exec.buf"
	{
		rc=0
		eval "${vm_dryrun:+debug_exec} $qemu_exec $qemu_args" ||
			rc=$?
		printf '%s\n' "$rc" > "$buf"
	} |
		tee "$qemu_logfile"
	read rc < "$buf"
	rm -f -- "$buf"
	exit $rc
fi

eval "${vm_dryrun:+debug_exec} $qemu_exec $qemu_args"
