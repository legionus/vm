#!/bin/sh -efu

. shell-error
. shell-git-config

. "@PREFIX@/vm-sh-config"

debug_exec() {
	printf '%s \\\n' "$1"; shift
	opt=
	for a; do
		if [ -z "${a##-*}" ]; then
			[ -z "$opt" ] || printf '\\\n'
			printf '\t%s ' "$a"
			opt=1
		else
			printf '"%s" \\\n' "$a"
			opt=
		fi
	done
	printf '\t#\n'
}

git_config_location_exists "$vm_config_file" "vm.$vm_profile" ||
	fatal "Profile not exists: vm.$vm_profile"

vm_read_config "$vm_config_file"

if [ -n "$qemu_logfile" ]; then
	buf="$(mktemp "$workdir/qemu.XXXXXX")"
	{
		rc=0
		${vm_dryrun:+debug_exec} \
		$qemu_exec $qemu_args ${qemu_cmdline:+-append "$qemu_cmdline"} ||
			rc=$?
		printf '%s\n' "$rc" > "$buf"
	} |
		tee "$qemu_logfile"
	read rc < "$buf"
	exit $rc
fi

${vm_dryrun:+debug_exec} \
$qemu_exec $qemu_args ${qemu_cmdline:+-append "$qemu_cmdline"}
