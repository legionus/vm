#!/bin/sh -efu

if [ -n "${VM_HELP-}" ]; then
	printf 'Starts a virtual machine according to specified profile\n'
	exit 0
fi

. "@PREFIX@/vm-sh-config"
. "@PREFIX@/vm-sh-functions"

debug_exec() {
	printf '%s \\\n' "$1"; shift
	opt=
	for a; do
		if [ -z "${a##-*}" ]; then
			[ -z "$opt" ] || printf '\\\n'
			printf '\t%s ' "$a"
			opt=1
		else
			printf '"%s" \\\n' "$a"
			opt=
		fi
	done
	printf '\t#\n'
}

vm_read_profile_config

if [ -n "$qemu_logfile" ]; then
	buf="$(mktemp "$workdir/qemu.XXXXXX")"
	{
		rc=0
		${vm_dryrun:+debug_exec} \
		$qemu_exec $qemu_args ${qemu_cmdline:+-append "$qemu_cmdline"} ||
			rc=$?
		printf '%s\n' "$rc" > "$buf"
	} |
		tee "$qemu_logfile"
	read rc < "$buf"
	exit $rc
fi

${vm_dryrun:+debug_exec} \
$qemu_exec $qemu_args ${qemu_cmdline:+-append "$qemu_cmdline"}
