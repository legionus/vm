#!/bin/sh -efu

if [ -n "${VM_HELP-}" ]; then
	printf 'Shows the configuration and the command to be executed\n'
	exit 0
fi

if [ -n "${VM_HELP_OPTIONS-}" ]; then
	exit 0
fi

. "@PREFIX@/vm-sh-config"
. "@PREFIX@/vm-sh-functions"

vm_read_profile_config

printf 'Profile: vm.%s\n' "$vm_profile"
printf 'Configuration:\n'
for n in $vm_params; do
	eval "t=\"\${${n}_type-}\""
	eval "v=\"\${${n}-}\""

	if [ "$t" = one ]; then
		printf -- '- %s: %s\n' "$n" "$v"
	fi

	if [ "$t" = list ]; then
		s='(empty list)'
		[ $v -eq 0 ] || s=
		printf -- '- %s: %s\n' "$n" "$s"
		i=0
		while [ $i -lt "${v:-0}" ]; do
			eval "vv=\"\${${n}_$i-}\""
			printf -- '  + %s\n' "$vv"
			i=$(($i+1))
		done
	fi
done
printf '\n'

printf 'Command to execute:\n'
printf '%s \\\n' "$qemu_exec"
eval set -- $qemu_args
opt=
for a; do
	if [ -z "${a##-*}" ]; then
		[ -z "$opt" ] || printf '\\\n'
		printf '\t%s ' "$a"
		opt=1
	else
		printf '"%s" \\\n' "$a"
		opt=
	fi
done
printf '\t#\n'
